<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKX Wallet Debug Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            background: #2a2a2a;
            border-radius: 8px;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .logs {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 12px;
        }
        .clear {
            background: #dc3545;
        }
        .clear:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ OKX Wallet Debug Test</h1>

    <div class="section">
        <h3>Provider Detection</h3>
        <button class="button" onclick="detectProviders()">æ£€æµ‹é’±åŒ…</button>
        <button class="button" onclick="testOKXDirect()">ç›´æ¥æµ‹è¯•OKX</button>
        <button class="button" onclick="testOKXNoTimeout()">æµ‹è¯•OKX(æ— è¶…æ—¶)</button>
        <button class="button" onclick="testOKXEnable()">æµ‹è¯•OKXå¯ç”¨</button>
        <button class="button" onclick="testOKXAlternativeMethods()">æµ‹è¯•OKXå¤‡ç”¨æ–¹æ³•</button>
        <button class="button" onclick="testOKXChainIdFirst()">æµ‹è¯•OKXé“¾IDä¼˜å…ˆ</button>
        <button class="button" onclick="testEthereumDirect()">ç›´æ¥æµ‹è¯•Ethereum</button>
        <button class="button" onclick="testForceOKXPopup()">å¼ºåˆ¶æµ‹è¯•OKXå¼¹çª—</button>
        <button class="button" onclick="testWalletSDKDetection()">æµ‹è¯•WalletSDKæ£€æµ‹</button>
        <button class="button" onclick="diagnoseOKXIssue()">è¯Šæ–­OKXé—®é¢˜</button>
        <button class="button" onclick="testDirectConnection()">ç›´æ¥è¿æ¥æµ‹è¯•</button>
    </div>

    <div class="section">
        <h3>Connection Tests</h3>
        <button class="button" onclick="testOKXConnection()">OKX è¿æ¥æµ‹è¯•</button>
        <button class="button" onclick="testMetaMaskConnection()">MetaMask è¿æ¥æµ‹è¯•</button>
    </div>

    <div class="section">
        <h3>Debug Controls</h3>
        <button class="button clear" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
        <button class="button" onclick="checkWindowObjects()">æ£€æŸ¥Windowå¯¹è±¡</button>
    </div>

    <div class="section">
        <h3>Console Logs</h3>
        <div id="logs" class="logs"></div>
    </div>

    <script>
        let logs = [];

        function log(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            logs.push(logMessage);

            if (data) {
                logs.push(JSON.stringify(data, null, 2));
            }

            updateLogsDisplay();
            console.log(logMessage, data || '');
        }

        function error(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] âŒ ERROR: ${message}`;
            logs.push(logMessage);

            if (data) {
                logs.push(JSON.stringify(data, null, 2));
            }

            updateLogsDisplay();
            console.error(logMessage, data || '');
        }

        function updateLogsDisplay() {
            document.getElementById('logs').textContent = logs.join('\n');
            document.getElementById('logs').scrollTop = document.getElementById('logs').scrollHeight;
        }

        function clearLogs() {
            logs = [];
            updateLogsDisplay();
        }

        function detectProviders() {
            log('=== å¼€å§‹æ£€æµ‹é’±åŒ…æä¾›è€… (EIP-6963ä¼˜å…ˆ) ===');

            // é¦–å…ˆå°è¯•EIP-6963æ£€æµ‹
            detectEIP6963Providers();

            // ç„¶åæ£€æŸ¥ä¼ ç»Ÿæ–¹å¼
            setTimeout(() => {
                detectLegacyProviders();
            }, 200);
        }

        function detectEIP6963Providers() {
            log('ğŸ” EIP-6963æ ‡å‡†æ£€æµ‹...');

            const announceEvent = 'eip6963:announceProvider';
            const requestEvent = 'eip6963:requestProvider';
            const detectedWallets = [];

            const handleAnnounce = (event) => {
                const detail = event.detail;
                log(`ğŸ“¡ EIP-6963æ£€æµ‹åˆ°: ${detail.info.name}`, {
                    rdns: detail.info.rdns,
                    uuid: detail.info.uuid,
                    hasProvider: !!detail.provider,
                    hasRequest: typeof detail.provider?.request === 'function'
                });

                detectedWallets.push(detail);
            };

            // è®¾ç½®ä¸´æ—¶ç›‘å¬å™¨
            window.addEventListener(announceEvent, handleAnnounce);

            // å‘é€è¯·æ±‚
            window.dispatchEvent(new Event(requestEvent));

            // ç­‰å¾…å“åº”åæ¸…ç†
            setTimeout(() => {
                window.removeEventListener(announceEvent, handleAnnounce);

                if (detectedWallets.length === 0) {
                    log('âš ï¸ æœªé€šè¿‡EIP-6963æ£€æµ‹åˆ°é’±åŒ…');
                } else {
                    log(`âœ… EIP-6963æ£€æµ‹åˆ° ${detectedWallets.length} ä¸ªé’±åŒ…`);

                    // æ£€æŸ¥æ˜¯å¦æœ‰OKX
                    const okxWallet = detectedWallets.find(w =>
                        w.info.rdns.toLowerCase().includes('okx') ||
                        w.info.name.toLowerCase().includes('okx')
                    );

                    if (okxWallet) {
                        log('ğŸ¯ é€šè¿‡EIP-6963æ‰¾åˆ°OKXé’±åŒ…!');
                    }
                }
            }, 300);
        }

        function detectLegacyProviders() {
            log('ğŸ” Legacyæ–¹å¼æ£€æµ‹...');

            // æ£€æŸ¥ window.ethereum
            if (window.ethereum) {
                log('âœ… window.ethereum å­˜åœ¨');
                log('window.ethereum ç±»å‹:', typeof window.ethereum);
                log('window.ethereum æ ‡è¯†:', {
                    isMetaMask: window.ethereum.isMetaMask,
                    isOkxWallet: window.ethereum.isOkxWallet,
                    isCoinbaseWallet: window.ethereum.isCoinbaseWallet,
                    isRabby: window.ethereum.isRabby,
                    isTrust: window.ethereum.isTrust
                });

                // æ£€æŸ¥æ˜¯å¦æœ‰requestæ–¹æ³•
                if (typeof window.ethereum.request === 'function') {
                    log('âœ… window.ethereum.request æ–¹æ³•å­˜åœ¨');
                } else {
                    error('âŒ window.ethereum.request æ–¹æ³•ä¸å­˜åœ¨');
                }
            } else {
                error('âŒ window.ethereum ä¸å­˜åœ¨');
            }

            // æ£€æŸ¥ window.okxwallet
            if (window.okxwallet) {
                log('âœ… window.okxwallet å­˜åœ¨');
                log('window.okxwallet ç±»å‹:', typeof window.okxwallet);

                // æ£€æŸ¥æ˜¯å¦æœ‰requestæ–¹æ³•
                if (typeof window.okxwallet.request === 'function') {
                    log('âœ… window.okxwallet.request æ–¹æ³•å­˜åœ¨');
                } else {
                    error('âŒ window.okxwallet.request æ–¹æ³•ä¸å­˜åœ¨');
                }
            } else {
                log('âš ï¸ window.okxwallet ä¸å­˜åœ¨');
            }

            // æ£€æŸ¥å…¶ä»–é’±åŒ…
            const otherWallets = ['coinbaseWalletExtension', 'rabby', 'trustWallet'];
            otherWallets.forEach(wallet => {
                if (window[wallet]) {
                    log(`âœ… window.${wallet} å­˜åœ¨`);
                } else {
                    log(`âš ï¸ window.${wallet} ä¸å­˜åœ¨`);
                }
            });
        }

        function checkWindowObjects() {
            log('=== æ£€æŸ¥Windowå¯¹è±¡ ===');
            const windowProps = Object.keys(window);
            const walletRelated = windowProps.filter(prop =>
                prop.toLowerCase().includes('wallet') ||
                prop.toLowerCase().includes('ethereum') ||
                prop.toLowerCase().includes('okx') ||
                prop.toLowerCase().includes('metamask') ||
                prop.toLowerCase().includes('coinbase') ||
                prop.toLowerCase().includes('rabby') ||
                prop.toLowerCase().includes('trust')
            );

            log('é’±åŒ…ç›¸å…³å¯¹è±¡:', walletRelated);
        }

        async function testOKXDirect() {
            log('=== ç›´æ¥æµ‹è¯•OKX Wallet ===');

            try {
                let provider = window.okxwallet;

                if (!provider) {
                    // å°è¯• window.ethereum.isOkxWallet
                    if (window.ethereum && window.ethereum.isOkxWallet) {
                        provider = window.ethereum;
                        log('ä½¿ç”¨ window.ethereum (isOkxWallet: true)');
                    } else {
                        error('æœªæ‰¾åˆ°OKX Walletæä¾›è€…');
                        return;
                    }
                } else {
                    log('ä½¿ç”¨ window.okxwallet');
                }

                log('OKX Providerä¿¡æ¯:', {
                    type: typeof provider,
                    hasRequest: typeof provider.request === 'function',
                    methods: Object.getOwnPropertyNames(provider).filter(n => typeof provider[n] === 'function')
                });

                // æµ‹è¯•è¯·æ±‚
                if (typeof provider.request === 'function') {
                    log('æµ‹è¯• eth_chainId è¯·æ±‚...');
                    try {
                        const chainId = await provider.request({ method: 'eth_chainId' });
                        log('âœ… eth_chainId æˆåŠŸ:', chainId);
                    } catch (e) {
                        error('eth_chainId å¤±è´¥:', e.message);
                    }

                    log('æµ‹è¯• eth_requestAccounts è¯·æ±‚...');
                    try {
                        const accounts = await Promise.race([
                            provider.request({ method: 'eth_requestAccounts' }),
                            new Promise((_, reject) => setTimeout(() => reject(new Error('30ç§’è¶…æ—¶')), 30000))
                        ]);
                        log('âœ… eth_requestAccounts æˆåŠŸ:', accounts);
                    } catch (e) {
                        error('eth_requestAccounts å¤±è´¥:', e.message);
                    }
                } else {
                    error('OKX Provider æ²¡æœ‰ request æ–¹æ³•');
                }

            } catch (e) {
                error('OKXæµ‹è¯•å¤±è´¥:', e.message);
            }
        }

        async function testEthereumDirect() {
            log('=== ç›´æ¥æµ‹è¯•Ethereum ===');

            try {
                const provider = window.ethereum;

                if (!provider) {
                    error('window.ethereum ä¸å­˜åœ¨');
                    return;
                }

                log('Ethereum Providerä¿¡æ¯:', {
                    type: typeof provider,
                    hasRequest: typeof provider.request === 'function',
                    methods: Object.getOwnPropertyNames(provider).filter(n => typeof provider[n] === 'function'),
                    flags: {
                        isMetaMask: provider.isMetaMask,
                        isOkxWallet: provider.isOkxWallet,
                        isCoinbaseWallet: provider.isCoinbaseWallet
                    }
                });

                // æµ‹è¯•è¯·æ±‚
                if (typeof provider.request === 'function') {
                    log('æµ‹è¯• eth_chainId è¯·æ±‚...');
                    try {
                        const chainId = await provider.request({ method: 'eth_chainId' });
                        log('âœ… eth_chainId æˆåŠŸ:', chainId);
                    } catch (e) {
                        error('eth_chainId å¤±è´¥:', e.message);
                    }

                    log('æµ‹è¯• eth_requestAccounts è¯·æ±‚...');
                    try {
                        const accounts = await Promise.race([
                            provider.request({ method: 'eth_requestAccounts' }),
                            new Promise((_, reject) => setTimeout(() => reject(new Error('30ç§’è¶…æ—¶')), 30000))
                        ]);
                        log('âœ… eth_requestAccounts æˆåŠŸ:', accounts);
                    } catch (e) {
                        error('eth_requestAccounts å¤±è´¥:', e.message);
                    }
                } else {
                    error('Ethereum Provider æ²¡æœ‰ request æ–¹æ³•');
                }

            } catch (e) {
                error('Ethereumæµ‹è¯•å¤±è´¥:', e.message);
            }
        }

        async function testOKXConnection() {
            log('=== OKXè¿æ¥æµ‹è¯• (æ¨¡æ‹ŸSDKé€»è¾‘) ===');

            try {
                // æ¨¡æ‹Ÿæˆ‘ä»¬SDKçš„é€»è¾‘
                const windowEth = window;
                const ethereum = windowEth.ethereum;

                if (!ethereum) {
                    error('window.ethereum ä¸å­˜åœ¨');
                    return;
                }

                const provider = ethereum;

                // æ£€æµ‹OKX
                log('æ£€æµ‹OKX Wallet:', {
                    'window.ethereum.isOkxWallet': provider.isOkxWallet,
                    'window.okxwallet': !!windowEth.okxwallet,
                    'window.ethereum exists': !!provider
                });

                if (provider.isOkxWallet || windowEth.okxwallet) {
                    const okxProvider = windowEth.okxwallet || provider;
                    log('ä½¿ç”¨OKX Provider:', {
                        'provider': okxProvider === provider ? 'window.ethereum' : 'window.okxwallet',
                        'has request': typeof okxProvider.request === 'function',
                        'provider methods': Object.getOwnPropertyNames(okxProvider).filter(n => typeof okxProvider[n] === 'function')
                    });

                    // å°è¯•è¿æ¥
                    log('ğŸ”„ OKX Wallet è¿æ¥ä¸­...');

                    const timeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => reject(new Error('è¿æ¥è¯·æ±‚è¶…æ—¶')), 30000);
                    });

                    const requestPayload = {
                        method: 'eth_requestAccounts',
                        params: []
                    };

                    log('ğŸš€ å‘é€è¯·æ±‚:', requestPayload);

                    let accountsPromise;
                    try {
                        accountsPromise = okxProvider.request(requestPayload);
                        log('â³ ç­‰å¾…å“åº”...');
                    } catch (syncError) {
                        error('åŒæ­¥è¯·æ±‚å¤±è´¥:', syncError.message);
                        throw syncError;
                    }

                    let accounts;
                    try {
                        accounts = await Promise.race([accountsPromise, timeoutPromise]);
                        log('âœ… è¿æ¥æˆåŠŸ:', accounts);
                    } catch (asyncError) {
                        error('å¼‚æ­¥è¯·æ±‚å¤±è´¥:', asyncError.message);
                        throw asyncError;
                    }

                } else {
                    error('æœªæ£€æµ‹åˆ°OKX Wallet');
                }

            } catch (e) {
                error('OKXè¿æ¥æµ‹è¯•å¤±è´¥:', e.message);
            }
        }

        async function testOKXEnable() {
            log('=== OKXå¯ç”¨æµ‹è¯• ===');

            try {
                if (!window.okxwallet) {
                    error('window.okxwallet ä¸å­˜åœ¨');
                    return;
                }

                log('OKX Wallet å¯¹è±¡ä¿¡æ¯:', {
                    'type': typeof window.okxwallet,
                    'constructor': window.okxwallet.constructor.name,
                    'keys': Object.keys(window.okxwallet),
                    'methods': Object.getOwnPropertyNames(window.okxwallet).filter(n => typeof window.okxwallet[n] === 'function')
                });

                // æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨æˆ–è¿æ¥æ–¹æ³•
                const possibleMethods = ['enable', 'connect', 'requestAccounts', 'isConnected', 'isUnlocked'];
                for (const method of possibleMethods) {
                    if (typeof window.okxwallet[method] === 'function') {
                        log(`å‘ç°æ–¹æ³• ${method}:`, window.okxwallet[method]);
                    }
                }

                // æµ‹è¯• enable æ–¹æ³• (ä¸€äº›æ—§é’±åŒ…éœ€è¦è¿™ä¸ª)
                if (typeof window.okxwallet.enable === 'function') {
                    log('æµ‹è¯• enable() æ–¹æ³•...');
                    try {
                        const result = await window.okxwallet.enable();
                        log('âœ… enable() æˆåŠŸ:', result);
                    } catch (e) {
                        error('enable() å¤±è´¥:', e.message);
                    }
                }

                // æµ‹è¯•è¿æ¥çŠ¶æ€
                if (typeof window.okxwallet.isConnected === 'function') {
                    log('æµ‹è¯• isConnected()...');
                    try {
                        const connected = await window.okxwallet.isConnected();
                        log('âœ… isConnected():', connected);
                    } catch (e) {
                        error('isConnected() å¤±è´¥:', e.message);
                    }
                }

            } catch (e) {
                error('OKXå¯ç”¨æµ‹è¯•å¤±è´¥:', e.message);
            }
        }

        async function testOKXAlternativeMethods() {
            log('=== OKXå¤‡ç”¨è¿æ¥æ–¹æ³•æµ‹è¯• ===');

            try {
                if (!window.okxwallet) {
                    error('window.okxwallet ä¸å­˜åœ¨');
                    return;
                }

                // æ–¹æ³•1: ç›´æ¥è°ƒç”¨ enable (å¦‚æœæœ‰)
                if (typeof window.okxwallet.enable === 'function') {
                    log('æ–¹æ³•1: æµ‹è¯• enable()...');
                    try {
                        const result = await window.okxwallet.enable();
                        log('âœ… enable() æˆåŠŸ:', result);

                        // enableæˆåŠŸåï¼Œå°è¯•æ ‡å‡†RPC
                        log('enableåæµ‹è¯• eth_chainId...');
                        const chainId = await window.okxwallet.request({ method: 'eth_chainId' });
                        log('âœ… enableå eth_chainId æˆåŠŸ:', chainId);

                        return; // å¦‚æœè¿™ä¸ªæ–¹æ³•æˆåŠŸï¼Œå°±ä¸æµ‹è¯•å…¶ä»–æ–¹æ³•äº†
                    } catch (e) {
                        error('enable() æ–¹æ³•å¤±è´¥:', e.message);
                    }
                }

                // æ–¹æ³•2: ä½¿ç”¨ eth_accounts è€Œä¸æ˜¯ eth_requestAccounts
                log('æ–¹æ³•2: æµ‹è¯• eth_accounts...');
                try {
                    const accounts = await window.okxwallet.request({ method: 'eth_accounts' });
                    log('âœ… eth_accounts æˆåŠŸ:', accounts);

                    if (accounts.length > 0) {
                        log('âœ… é’±åŒ…å·²æˆæƒï¼Œå¯ä»¥ä½¿ç”¨ç°æœ‰è´¦æˆ·');
                    } else {
                        log('âš ï¸ é’±åŒ…æœªæˆæƒï¼Œéœ€è¦ eth_requestAccounts');
                    }
                } catch (e) {
                    error('eth_accounts å¤±è´¥:', e.message);
                }

                // æ–¹æ³•3: æµ‹è¯• personal_sign æ¥è§¦å‘è¿æ¥
                log('æ–¹æ³•3: æµ‹è¯• personal_sign è§¦å‘è¿æ¥...');
                try {
                    const testMessage = 'OKX Wallet connection test';
                    const testAddress = '0x0000000000000000000000000000000000000000';

                    await window.okxwallet.request({
                        method: 'personal_sign',
                        params: [testMessage, testAddress]
                    });
                } catch (e) {
                    log('personal_sign é¢„æœŸå¤±è´¥ (éœ€è¦å…ˆè¿æ¥):', e.message);
                }

                // æ–¹æ³•4: æ£€æŸ¥æ˜¯å¦æœ‰OKXç‰¹å®šçš„åˆå§‹åŒ–æ–¹æ³•
                const okxSpecificMethods = ['okx_getProvider', 'okx_requestAccounts', 'okx_enable'];
                for (const method of okxSpecificMethods) {
                    if (typeof window.okxwallet[method] === 'function') {
                        log(`å‘ç°OKXç‰¹å®šæ–¹æ³• ${method}ï¼Œæµ‹è¯•ä¸­...`);
                        try {
                            const result = await window.okxwallet[method]();
                            log(`âœ… ${method} æˆåŠŸ:`, result);
                        } catch (e) {
                            error(`${method} å¤±è´¥:`, e.message);
                        }
                    }
                }

                // æ–¹æ³•5: æ£€æŸ¥provideräº‹ä»¶ç›‘å¬
                log('æ–¹æ³•5: è®¾ç½®äº‹ä»¶ç›‘å¬å™¨...');
                try {
                    window.okxwallet.on('connect', (connectInfo) => {
                        log('âœ… æ”¶åˆ° connect äº‹ä»¶:', connectInfo);
                    });

                    window.okxwallet.on('accountsChanged', (accounts) => {
                        log('âœ… æ”¶åˆ° accountsChanged äº‹ä»¶:', accounts);
                    });

                    window.okxwallet.on('chainChanged', (chainId) => {
                        log('âœ… æ”¶åˆ° chainChanged äº‹ä»¶:', chainId);
                    });

                    log('âœ… äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');
                } catch (e) {
                    error('è®¾ç½®äº‹ä»¶ç›‘å¬å™¨å¤±è´¥:', e.message);
                }

            } catch (e) {
                error('OKXå¤‡ç”¨è¿æ¥æ–¹æ³•æµ‹è¯•å¤±è´¥:', e.message);
            }
        }

        async function testOKXChainIdFirst() {
            log('=== OKXå…ˆæµ‹è¯•é“¾IDå†è¿æ¥ ===');

            try {
                if (!window.okxwallet) {
                    error('window.okxwallet ä¸å­˜åœ¨');
                    return;
                }

                // å…ˆæµ‹è¯•æœ€åŸºæœ¬çš„RPCæ–¹æ³•
                log('æ­¥éª¤1: æµ‹è¯• eth_chainId...');
                try {
                    const chainId = await window.okxwallet.request({ method: 'eth_chainId' });
                    log('âœ… eth_chainId æˆåŠŸ:', chainId);
                } catch (e) {
                    error('eth_chainId å¤±è´¥:', e.message);
                    return;
                }

                // å†æµ‹è¯•å…¶ä»–åŸºæœ¬ä¿¡æ¯
                log('æ­¥éª¤2: æµ‹è¯• net_version...');
                try {
                    const netVersion = await window.okxwallet.request({ method: 'net_version' });
                    log('âœ… net_version æˆåŠŸ:', netVersion);
                } catch (e) {
                    error('net_version å¤±è´¥:', e.message);
                }

                // æ£€æŸ¥æ˜¯å¦å·²è¿æ¥è´¦æˆ·
                log('æ­¥éª¤3: æ£€æŸ¥ç°æœ‰è´¦æˆ·...');
                try {
                    const accounts = await window.okxwallet.request({ method: 'eth_accounts' });
                    log('âœ… eth_accounts æˆåŠŸ:', accounts);

                    if (accounts.length > 0) {
                        log('âœ… å·²æœ‰æˆæƒè´¦æˆ·ï¼Œæ— éœ€é‡æ–°è¿æ¥');
                        return;
                    }
                } catch (e) {
                    error('eth_accounts å¤±è´¥:', e.message);
                }

                // æœ€åå°è¯•è¿æ¥
                log('æ­¥éª¤4: è¯·æ±‚è¿æ¥...');
                try {
                    const accounts = await Promise.race([
                        window.okxwallet.request({ method: 'eth_requestAccounts' }),
                        new Promise((_, reject) => setTimeout(() => reject(new Error('60ç§’è¶…æ—¶')), 60000))
                    ]);
                    log('âœ… eth_requestAccounts æˆåŠŸ:', accounts);
                } catch (e) {
                    error('eth_requestAccounts å¤±è´¥:', e.message);
                }

            } catch (e) {
                error('OKXé“¾IDä¼˜å…ˆæµ‹è¯•å¤±è´¥:', e.message);
            }
        }

        async function testOKXNoTimeout() {
            log('=== OKXè¿æ¥æµ‹è¯• (æ— è¶…æ—¶é™åˆ¶) ===');

            try {
                const provider = window.okxwallet;

                if (!provider) {
                    error('window.okxwallet ä¸å­˜åœ¨');
                    return;
                }

                log('ä½¿ç”¨ window.okxwallet (æ— è¶…æ—¶)');

                log('æµ‹è¯• eth_chainId...');
                try {
                    const chainId = await provider.request({ method: 'eth_chainId' });
                    log('âœ… eth_chainId æˆåŠŸ:', chainId);
                } catch (e) {
                    error('eth_chainId å¤±è´¥:', e.message);
                }

                log('æµ‹è¯• eth_requestAccounts (æ— è¶…æ—¶é™åˆ¶)...');
                log('âš ï¸ æ³¨æ„: å¦‚æœOKX Walletæ²¡æœ‰å“åº”ï¼Œè¿™ä¸ªæµ‹è¯•å¯èƒ½ä¼šä¸€ç›´ç­‰å¾…');
                log('ğŸ’¡ è¯·æ‰‹åŠ¨åœ¨æµè§ˆå™¨ä¸­æ£€æŸ¥æ˜¯å¦æœ‰OKX Walletçš„è¿æ¥å¼¹çª—');

                const accounts = await provider.request({ method: 'eth_requestAccounts' });
                log('âœ… eth_requestAccounts æˆåŠŸ (æ— è¶…æ—¶):', accounts);

            } catch (e) {
                error('OKXè¿æ¥æµ‹è¯•å¤±è´¥ (æ— è¶…æ—¶):', e.message);
            }
        }

        async function testMetaMaskConnection() {
            log('=== MetaMaskè¿æ¥æµ‹è¯• ===');

            try {
                const provider = window.ethereum;

                if (!provider || !provider.isMetaMask) {
                    error('MetaMaskä¸å­˜åœ¨æˆ–ä¸æ˜¯å½“å‰æä¾›è€…');
                    return;
                }

                log('ä½¿ç”¨MetaMask Provider');

                const accounts = await Promise.race([
                    provider.request({ method: 'eth_requestAccounts' }),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('30ç§’è¶…æ—¶')), 30000))
                ]);

                log('âœ… MetaMaskè¿æ¥æˆåŠŸ:', accounts);

            } catch (e) {
                error('MetaMaskè¿æ¥æµ‹è¯•å¤±è´¥:', e.message);
            }
        }

        async function testForceOKXPopup() {
            log('=== å¼ºåˆ¶æµ‹è¯•OKXå¼¹çª— ===');

            // 1. é¦–å…ˆæ£€æŸ¥OKXæ˜¯å¦å®‰è£…
            if (!window.okxwallet && !window.ethereum?.isOkxWallet) {
                error('âŒ OKXé’±åŒ…æœªå®‰è£…ï¼è¯·å…ˆå®‰è£…OKXé’±åŒ…æµè§ˆå™¨æ’ä»¶');
                error('ğŸ“¥ ä¸‹è½½åœ°å€: https://www.okx.com/web3');
                return;
            }

            // 2. ç¡®å®šä½¿ç”¨å“ªä¸ªprovider
            let provider = null;
            let providerName = '';

            if (window.okxwallet && typeof window.okxwallet.request === 'function') {
                provider = window.okxwallet;
                providerName = 'window.okxwallet';
                log('âœ… ä½¿ç”¨ window.okxwallet');
            } else if (window.ethereum?.isOkxWallet && typeof window.ethereum.request === 'function') {
                provider = window.ethereum;
                providerName = 'window.ethereum (OKX)';
                log('âœ… ä½¿ç”¨ window.ethereum (isOkxWallet)');
            } else {
                error('âŒ æ‰¾ä¸åˆ°æœ‰æ•ˆçš„OKX provider');
                return;
            }

            // 3. æµ‹è¯•åŸºæœ¬RPCè°ƒç”¨
            log(`ğŸ” æµ‹è¯• ${providerName} çš„åŸºæœ¬åŠŸèƒ½...`);
            try {
                const chainId = await provider.request({ method: 'eth_chainId' });
                log('âœ… eth_chainId æˆåŠŸ:', chainId);
            } catch (e) {
                error('âŒ eth_chainId å¤±è´¥ï¼Œproviderå¯èƒ½æœ‰é—®é¢˜:', e.message);
                return;
            }

            // 4. å¼ºåˆ¶è§¦å‘è¿æ¥è¯·æ±‚
            log('ğŸš€ å¼ºåˆ¶å‘é€è¿æ¥è¯·æ±‚...');
            log('âš ï¸ æ³¨æ„è§‚å¯Ÿæµè§ˆå™¨æ˜¯å¦å‡ºç°OKXé’±åŒ…çš„è¿æ¥å¼¹çª—');

            try {
                const accounts = await provider.request({
                    method: 'eth_requestAccounts'
                });
                log('âœ… è¿æ¥æˆåŠŸï¼è¿”å›çš„è´¦æˆ·:', accounts);
            } catch (error) {
                const msg = error.message || error.toString();

                if (msg.includes('User rejected') || msg.includes('User denied') || msg.includes('ç”¨æˆ·æ‹’ç»')) {
                    log('â„¹ï¸ ç”¨æˆ·æ‹’ç»äº†è¿æ¥è¯·æ±‚ï¼ˆè¿™æ˜¯æ­£å¸¸çš„ï¼‰');
                } else if (msg.includes('Already processing')) {
                    log('âš ï¸ é’±åŒ…æ­£åœ¨å¤„ç†å…¶ä»–è¯·æ±‚ï¼Œè¯·ç¨åé‡è¯•');
                } else {
                    error('âŒ è¿æ¥å¤±è´¥:', msg);
                }
            }
        }

        async function testWalletSDKDetection() {
            log('=== WalletSDKæ£€æµ‹æµ‹è¯• ===');

            try {
                // å¯¼å…¥WalletSDK (è¿™åœ¨å®é™…ä½¿ç”¨ä¸­ä¼šé€šè¿‡ESæ¨¡å—å¯¼å…¥)
                log('â„¹ï¸ æ³¨æ„: è¿™ä¸ªæµ‹è¯•æ¨¡æ‹ŸWalletSDKçš„æ£€æµ‹é€»è¾‘');

                // æ¨¡æ‹ŸEIP-6963æ£€æµ‹
                await testEIP6963Detection();

            } catch (error) {
                error('WalletSDKæ£€æµ‹å¤±è´¥:', error.message);
            }
        }

        async function testEIP6963Detection() {
            log('=== EIP-6963 æ ‡å‡†æ£€æµ‹ ===');

            const announceEvent = 'eip6963:announceProvider';
            const requestEvent = 'eip6963:requestProvider';

            // æ”¶é›†æ£€æµ‹åˆ°çš„é’±åŒ…
            const detectedWallets = [];

            const handleAnnounce = (event) => {
                const detail = event.detail;
                log('ğŸ“¡ æ”¶åˆ°EIP-6963é’±åŒ…å…¬å‘Š:', {
                    name: detail.info.name,
                    rdns: detail.info.rdns,
                    uuid: detail.info.uuid,
                    hasProvider: !!detail.provider,
                    hasRequest: typeof detail.provider?.request === 'function'
                });

                detectedWallets.push(detail);
            };

            // ç›‘å¬å…¬å‘Šäº‹ä»¶
            window.addEventListener(announceEvent, handleAnnounce);

            try {
                // å‘é€è¯·æ±‚äº‹ä»¶
                log('ğŸ“¤ å‘é€EIP-6963è¯·æ±‚äº‹ä»¶...');
                window.dispatchEvent(new Event(requestEvent));

                // ç­‰å¾…é’±åŒ…å“åº”
                await new Promise(resolve => setTimeout(resolve, 500));

                if (detectedWallets.length === 0) {
                    log('âš ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ”¯æŒEIP-6963çš„é’±åŒ…');
                    log('ğŸ’¡ è¿™å¯èƒ½æ„å‘³ç€:');
                    log('   - é’±åŒ…ä¸æ”¯æŒEIP-6963æ ‡å‡†');
                    log('   - é’±åŒ…éœ€è¦é€šè¿‡Legacyæ–¹å¼æ£€æµ‹');
                    log('   - é’±åŒ…è¿˜æœªå®Œå…¨åŠ è½½');
                } else {
                    log(`âœ… æ£€æµ‹åˆ° ${detectedWallets.length} ä¸ªEIP-6963é’±åŒ…:`);
                    detectedWallets.forEach((wallet, index) => {
                        log(`   ${index + 1}. ${wallet.info.name} (${wallet.info.rdns})`);
                    });

                    // å°è¯•è¿æ¥OKXé’±åŒ…
                    const okxWallet = detectedWallets.find(w =>
                        w.info.rdns.includes('okx') ||
                        w.info.name.toLowerCase().includes('okx')
                    );

                    if (okxWallet) {
                        log('ğŸ¯ æ‰¾åˆ°OKXé’±åŒ…ï¼Œå°è¯•è¿æ¥...');
                        try {
                            const accounts = await okxWallet.provider.request({
                                method: 'eth_requestAccounts'
                            });
                            log('âœ… OKXè¿æ¥æˆåŠŸ:', accounts);
                        } catch (e) {
                            log('âŒ OKXè¿æ¥å¤±è´¥:', e.message);
                        }
                    }
                }

            } finally {
                // æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
                window.removeEventListener(announceEvent, handleAnnounce);
            }
        }

        async function diagnoseOKXIssue() {
            log('=== ğŸ” OKXé’±åŒ…é—®é¢˜è¯Šæ–­ ===');

            if (!window.okxwallet) {
                error('âŒ window.okxwallet ä¸å­˜åœ¨ï¼ŒOKXé’±åŒ…æœªå®‰è£…');
                return;
            }

            // 1. åŸºæœ¬ä¿¡æ¯æ£€æŸ¥
            log('1ï¸âƒ£ åŸºæœ¬ä¿¡æ¯æ£€æŸ¥...');
            log('Providerç±»å‹:', typeof window.okxwallet);
            log('æ„é€ å‡½æ•°:', window.okxwallet.constructor?.name || 'unknown');
            log('å¯ç”¨æ–¹æ³•:', Object.getOwnPropertyNames(window.okxwallet).filter(n => typeof window.okxwallet[n] === 'function'));

            // 2. æ£€æŸ¥å¿…è¦æ–¹æ³•
            log('2ï¸âƒ£ æ–¹æ³•å¯ç”¨æ€§æ£€æŸ¥...');
            const methods = ['request', 'send', 'sendAsync', 'disconnect', 'enable'];
            methods.forEach(method => {
                const available = typeof window.okxwallet[method] === 'function';
                log(`   ${method}: ${available ? 'âœ…' : 'âŒ'}`);
            });

            // 3. æµ‹è¯•åŸºç¡€RPC
            log('3ï¸âƒ£ åŸºç¡€RPCæµ‹è¯•...');
            try {
                // æµ‹è¯•ç®€å•çš„RPCè°ƒç”¨
                const chainId = await window.okxwallet.request({ method: 'eth_chainId' });
                log('âœ… eth_chainId æˆåŠŸ:', chainId);

                const netVersion = await window.okxwallet.request({ method: 'net_version' });
                log('âœ… net_version æˆåŠŸ:', netVersion);
            } catch (e) {
                error('âŒ åŸºç¡€RPCå¤±è´¥:', e.message);
            }

            // 4. æ£€æŸ¥å½“å‰è¿æ¥çŠ¶æ€
            log('4ï¸âƒ£ è¿æ¥çŠ¶æ€æ£€æŸ¥...');
            try {
                const accounts = await window.okxwallet.request({ method: 'eth_accounts' });
                if (accounts && accounts.length > 0) {
                    log('âœ… å·²è¿æ¥è´¦æˆ·:', accounts);
                } else {
                    log('âš ï¸ æœªè¿æ¥ä»»ä½•è´¦æˆ·');
                }
            } catch (e) {
                log('âš ï¸ æ— æ³•è·å–è´¦æˆ·çŠ¶æ€:', e.message);
            }

            // 5. æ£€æŸ¥æƒé™
            log('5ï¸âƒ£ æƒé™æ£€æŸ¥...');
            try {
                if (typeof window.okxwallet.request === 'function') {
                    // å°è¯•è·å–æƒé™ä¿¡æ¯
                    const permissions = await window.okxwallet.request({
                        method: 'wallet_getPermissions'
                    });
                    log('âœ… å½“å‰æƒé™:', permissions);
                } else {
                    log('âš ï¸ æ— æ³•æ£€æŸ¥æƒé™');
                }
            } catch (e) {
                log('âš ï¸ æƒé™æ£€æŸ¥å¤±è´¥:', e.message);
            }

            // 6. æµè§ˆå™¨ç¯å¢ƒæ£€æŸ¥
            log('6ï¸âƒ£ æµè§ˆå™¨ç¯å¢ƒæ£€æŸ¥...');
            log('User Agent:', navigator.userAgent);
            log('æ˜¯å¦HTTPS:', location.protocol === 'https:');
            log('æ˜¯å¦æœ¬åœ°ç¯å¢ƒ:', location.hostname === 'localhost' || location.hostname === '127.0.0.1');

            // 7. å¼¹çª—æµ‹è¯•å»ºè®®
            log('7ï¸âƒ£ å»ºè®®çš„è§£å†³æ–¹æ¡ˆ:');
            log('ğŸ’¡ è¯·æ£€æŸ¥ä»¥ä¸‹é¡¹ç›®:');
            log('   1. OKXé’±åŒ…æ˜¯å¦å¤„äºé”å®šçŠ¶æ€ï¼Ÿ');
            log('   2. æµè§ˆå™¨æ˜¯å¦é˜»æ­¢äº†å¼¹çª—ï¼Ÿ');
            log('   3. OKXé’±åŒ…æ˜¯å¦åœ¨åå°è¿è¡Œï¼Ÿ');
            log('   4. æ˜¯å¦æœ‰å…¶ä»–é’±åŒ…æ’ä»¶å†²çªï¼Ÿ');
            log('   5. å°è¯•æ‰‹åŠ¨ç‚¹å‡»OKXæ’ä»¶å›¾æ ‡æ¿€æ´»');

            // 8. é‡æ–°å°è¯•è¿æ¥ï¼ˆæ›´çŸ­è¶…æ—¶ï¼‰
            log('8ï¸âƒ£ é‡æ–°å°è¯•è¿æ¥ï¼ˆ5ç§’è¶…æ—¶ï¼‰...');
            try {
                const accounts = await Promise.race([
                    window.okxwallet.request({ method: 'eth_requestAccounts' }),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('5ç§’è¶…æ—¶')), 5000))
                ]);
                log('âœ… çŸ­è¶…æ—¶è¿æ¥æˆåŠŸ:', accounts);
            } catch (e) {
                error('âŒ çŸ­è¶…æ—¶è¿æ¥å¤±è´¥:', e.message);

                if (e.message.includes('5ç§’è¶…æ—¶')) {
                    log('ğŸ’¡ å»ºè®®: é’±åŒ…å¯èƒ½éœ€è¦æ‰‹åŠ¨æ¿€æ´»');
                    log('ğŸ”§ è§£å†³æ–¹æ¡ˆ:');
                    log('   1. ç‚¹å‡»æµè§ˆå™¨åœ°å€æ å³ä¾§çš„OKXæ’ä»¶å›¾æ ‡');
                    log('   2. ç¡®ä¿é’±åŒ…å·²è§£é”');
                    log('   3. å…³é—­å¯èƒ½é˜»æ­¢å¼¹çª—çš„æµè§ˆå™¨è®¾ç½®');
                    log('   4. åˆ·æ–°é¡µé¢åé‡è¯•');
                }
            }
        }

        async function testDirectConnection() {
            log('=== ğŸš€ ç›´æ¥è¿æ¥æµ‹è¯•ï¼ˆè·³è¿‡æ‰€æœ‰é¢„æ£€æŸ¥ï¼‰===');

            if (!window.okxwallet) {
                error('âŒ window.okxwallet ä¸å­˜åœ¨');
                return;
            }

            try {
                log('ğŸ¯ ç›´æ¥å‘é€è¿æ¥è¯·æ±‚ï¼Œæ— ä»»ä½•é¢„æ£€æŸ¥...');
                log('âš ï¸ è¯·æ³¨æ„è§‚å¯Ÿæµè§ˆå™¨æ˜¯å¦å¼¹å‡ºOKXé’±åŒ…æˆæƒçª—å£');

                // ç›´æ¥è¿æ¥ï¼Œä¸åšä»»ä½•é¢„æ£€æŸ¥
                const accounts = await window.okxwallet.request({
                    method: 'eth_requestAccounts'
                });

                log('ğŸ‰ è¿æ¥æˆåŠŸï¼è´¦æˆ·:', accounts);

                // å¦‚æœè¿æ¥æˆåŠŸï¼Œå†å°è¯•è·å–å…¶ä»–ä¿¡æ¯
                try {
                    const chainId = await window.okxwallet.request({ method: 'eth_chainId' });
                    log('âœ… é“¾ID:', chainId);
                } catch (e) {
                    log('âš ï¸ è·å–é“¾IDå¤±è´¥ï¼Œä½†è¿æ¥å·²æˆåŠŸ:', e.message);
                }

            } catch (error) {
                const msg = error.message || error.toString();

                if (msg.includes('User rejected') || msg.includes('User denied') || msg.includes('ç”¨æˆ·æ‹’ç»')) {
                    log('â„¹ï¸ ç”¨æˆ·æ‹’ç»äº†è¿æ¥è¯·æ±‚ï¼ˆè¿™æ˜¯æ­£å¸¸çš„ï¼‰');
                    log('ğŸ’¡ è¯´æ˜é’±åŒ…å¼¹çª—åŠŸèƒ½æ­£å¸¸ï¼Œåªæ˜¯ç”¨æˆ·é€‰æ‹©äº†æ‹’ç»');
                } else if (msg.includes('Already processing')) {
                    log('âš ï¸ é’±åŒ…æ­£åœ¨å¤„ç†å…¶ä»–è¯·æ±‚');
                    log('ğŸ’¡ å»ºè®®ï¼šç­‰å¾…å‡ ç§’åé‡è¯•ï¼Œæˆ–é‡å¯OKXé’±åŒ…');
                } else {
                    error('âŒ ç›´æ¥è¿æ¥å¤±è´¥:', msg);

                    // æä¾›å…·ä½“çš„è§£å†³å»ºè®®
                    if (msg.includes('timeout') || msg.includes('è¶…æ—¶')) {
                        log('ğŸ’¡ è¶…æ—¶é—®é¢˜è§£å†³å»ºè®®:');
                        log('   1. æ£€æŸ¥OKXé’±åŒ…æ˜¯å¦å¤„äºé”å®šçŠ¶æ€');
                        log('   2. ç‚¹å‡»æµè§ˆå™¨å³ä¸Šè§’çš„OKXæ’ä»¶å›¾æ ‡');
                        log('   3. ç¡®ä¿OKXé’±åŒ…å·²è§£é”å¹¶å¤„äºæ´»è·ƒçŠ¶æ€');
                        log('   4. æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦é˜»æ­¢äº†å¼¹çª—');
                    } else {
                        log('ğŸ’¡ å…¶ä»–é—®é¢˜è§£å†³å»ºè®®:');
                        log('   1. é‡å¯OKXé’±åŒ…æ’ä»¶');
                        log('   2. åˆ·æ–°å½“å‰é¡µé¢');
                        log('   3. æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–é’±åŒ…æ’ä»¶å†²çª');
                    }
                }
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æµ‹
        window.addEventListener('load', () => {
            log('ğŸš€ OKX Debugé¡µé¢å·²åŠ è½½');
            log('ğŸ’¡ æ¨èæµ‹è¯•é¡ºåº:');
            log('   1. æ£€æµ‹é’±åŒ… (EIP-6963ä¼˜å…ˆ)');
            log('   2. æµ‹è¯•WalletSDKæ£€æµ‹');
            log('   3. å¼ºåˆ¶æµ‹è¯•OKXå¼¹çª—');

            // è‡ªåŠ¨å¼€å§‹æ£€æµ‹
            detectProviders();
        });
    </script>
</body>
</html>